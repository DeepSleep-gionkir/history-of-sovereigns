# GDD-02: Core Mechanics & Logic

## Project Title: HISTORY OF SOVEREIGNS

### 2.1 시간 및 행동 시스템

**실시간** 흐름 속에 **턴제(쿨타임)** 제약이 존재하는 하이브리드 방식입니다.

#### A. 행동력 (Cooldown)

- **쿨타임:** 180초 (3분).
- **로직:** 유저 명령 접수 즉시 서버 타임스탬프 갱신.
- **행동 슬롯:** 동시에 1개만 활성. 동일 타임스탬프 내 중복 요청 차단.
- **가속/지연:** 전쟁 승리, 기술, 정책에 따라 ±30초 조정 가능. 최소 120초, 최대 240초로 캡.

#### B. 틱(Tick) 연출

- **서버:** 이벤트 트리거 기반 (별도 연산 X).
- **클라이언트:** `setInterval`로 자원 증가 시각적 연출.

### 2.2 명령 처리 알고리즘 (Server Authority)

1.  **요청 수신:** `POST /api/action`.
2.  **비동기 처리:** Gemini 2.5 Flash-Lite 호출.
3.  **데이터 반영:** Firestore 트랜잭션 업데이트.
4.  **결과 스트림:** 행동 로그, 뉴스 티커, 푸시 알림(선택)로 리턴.
5.  **락 정책:** 국가 단위 분산락(쿨타임 동안)으로 중복 처리 방지.

### 2.3 관리자 권한 (Admin Privileges)

관리자는 게임의 규칙을 초월하는 권한을 가집니다.

- **Override:** 쿨타임 무시, 자원 무한 생성, 특정 국가 강제 멸망(Ban).
- **Global Broadcast:** 전체 서버에 긴급 뉴스(속보) 강제 송출.
- **Access:** `/admin` 경로는 인증된 관리자 UID만 접속 가능.

### 2.4 오프라인 방어 (Lazy Evaluation)

- **피격 시:** 방어자가 OFFLINE이면 `pending_events` 큐에 적립.
- **복귀 시:** 누적 피해 데이터를 모아 '부재중 보고서' 생성.

### 2.5 행동 카테고리와 핵심 로직

- **내정:** 세금, 복지, 환경, 도시 건설, 종교/이념 선포. 행복도/안정도/자원 생산에 영향. 일부 행동은 지속 정책으로 등록되어 주기마다 자동 실행.
- **외교:** 동맹 체결, 불가침, 조공, 이민 허용, 문화 교류. 실패 시 영향력 감소, 성공 시 공동 버프 부여.
- **전쟁:** 침공, 기습, 포위, 해상 차단, 공중 타격(기술 조건). 전쟁은 3개 페이즈(개전-교전-결과)로 보고서 생성.
- **기술/문화:** 연구 투자, 도서관 건립, AI 의회 설치 등으로 `Technology`, `Sustainability`를 증가시키거나 전쟁/내정 행동의 쿨타임을 조정.
- **정보/첩보:** 정찰(적 stats/자원 공개), 허위 정보(뉴스 조작), 반란 선동(안정도 공격). 위험 행동은 실패 시 역추적 패널티.

### 2.6 이벤트 처리 순서 (Server Authority 상세)

1. **명령 파싱:** 자연어를 시스템 액션 템플릿에 매핑(정책, 전쟁, 외교, 이벤트).
2. **룰 검증:** 국가 상태(보호막, 쿨타임, 멸망 여부, 자원 보유량) 확인.
3. **전투/판정 계산:** 확률 기반이 아니라 가중치 기반(Stat + 지형 + 기술 + 사기 + 화력)으로 승산 계산. 무작위성은 ±5% 수준.
4. **결과 서술 생성:** Gemini로 요약된 보고서를 만들어 로그/뉴스에 기록.
5. **보호 장치:** 로직 실패/오류 시 디폴트 '부분 성공/부분 실패' 상태로 롤백 후 보호막 지급.

### 2.7 경제/자원 루프

- **생산:** 기후/경제 중점에 따른 기본 생산 + 정책/기술 버프.
- **소모:** 유지비(군대/건물), 전쟁 소모, 재난(기후/이벤트) 피해.
- **부족 시 패널티:** Food 부족 시 `Happiness` 감소, Energy 부족 시 생산 정지, Gold 부족 시 유지비 미지급으로 `Military` 감소.
- **적재 효과:** 추가 생산물(수출), 식량 잉여(인구 증가), 에너지 잉여(기술 가속) 등 긍정적 보너스 제공.

### 2.8 페널티/안전 장치

- **행동 악용 방지:** 같은 행동 반복 시 점감 효율(예: 약탈 2회째부터 절반).
- **패자 보호:** 패배 직후 4~8시간 보호막 + 약탈 상한 + 반란 이벤트 대신 구조 이벤트 등장.
- **밸런스 핫픽스:** 관리자 패널에서 계수 핫스왑 가능(전투 가중치, 자원 상한, 쿨타임 범위).
